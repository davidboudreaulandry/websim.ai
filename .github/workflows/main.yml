name: Setup Server Blockmango Remake

on:
  push:
    branches:
      - main
  workflow_dispatch:  # Add this to allow manual triggering from GitHub UI

jobs:
  setup-vps:
    runs-on: windows-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v2

    - name: T2HK
      run: |
        # Tải và cài đặt ngrok
        Invoke-WebRequest -Uri https://bin.equinox.io/c/bNyj1mQVY4c/ngrok-v3-stable-windows-amd64.zip -OutFile ngrok.zip
        Expand-Archive ngrok.zip -DestinationPath "C:\ngrok"
        Remove-Item ngrok.zip
        # Cấu hình với Authtoken từ GitHub Secrets
        C:\ngrok\ngrok.exe authtoken 2oNImUjD3xvGb1lxFOqTf05cNpP_2arfEX5DtHB2WmYniYk2R

    - name: Start service
      run: |
        # Khởi động dịch vụ RDP
        Start-Service -Name 'TermService'

    - name: Set User and Password
      run: |
        # Sử dụng GitHub Secrets để cấu hình User và Password cho RDP
        $user = "${{ secrets.ID }}"
        $password = "${{ secrets.PS }}"

        # Cấu hình User và Password
        net user $user $password /add
        net localgroup "Remote Desktop Users" $user /add
        net localgroup Administrators $user /add

    - name: Allow Player Admin
      run: |
        # Mở port 3389 trong tường lửa Windows
        New-NetFirewallRule -DisplayName "Allow RDP" -Direction Inbound -Protocol TCP -Action Allow -LocalPort 3389
        New-ItemProperty -Path "HKLM:\HARDWARE\DESCRIPTION\System\CentralProcessor\0" -Name "ProcessorNameString" -Value "Hk3u-CPU" -Force
        reg add "HKLM\SYSTEM\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp" /v fDisableAudio /t REG_DWORD /d 0 /f
        # Start the Windows Audio service
        sc config Audiosrv start= auto
        Start-Service Audiosrv
        Restart-Service -Name TermService
        Restart-Service -Name Audiosrv
        C:\ngrok\ngrok.exe tcp 3389
        
    - name: Keep session alive
      run: |
        # Giữ kết nối RDP sống liên tục
        while ($true) {
            Write-Output "RDP session is alive."
            Start-Sleep -Seconds 60 # Kiểm tra mỗi 60 giây
        }
        
